{"version":3,"sources":["../src/participants.js"],"names":["define","$","Str","ModalFactory","ModalEvents","Templates","Notification","Ajax","SELECTORS","SENDMESSAGESBUTTON","Participants","options","courseId","courseid","noteStateNames","stateHelpIcon","attachEventListeners","prototype","modal","on","e","preventDefault","html","selected","each","push","data","length","showSendMessage","fail","exception","users","Deferred","resolve","promise","titlePromise","get_string","when","create","type","types","SAVE_CANCEL","body","render","then","title","setTitle","setSaveButtonText","getRoot","hidden","BULKACTIONSELECT","focus","remove","bind","save","submitSendMessage","show","messageText","find","val","messages","i","touserid","text","call","methodname","args","messageIds","msg","addNotification","message","catch","done","params","JSON","parse","init"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Some UI stuff for participants page.\n * This is also used by the report/participants/index.php because it has the same functionality.\n *\n * @module     quiz_teacheroverview/participants\n * @package    quiz_teacheroverview\n * @copyright  2017 Damyon Wiese\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @author     Devlion Moodle Development <service@devlion.co>\n */\ndefine(['jquery', 'core/str', 'core/modal_factory', 'core/modal_events', 'core/templates', 'core/notification', 'core/ajax'],\n    function ($, Str, ModalFactory, ModalEvents, Templates, Notification, Ajax) {\n\n        var SELECTORS = {\n            SENDMESSAGESBUTTON: \"#sendmessage\"\n        };\n\n        /**\n         * Constructor\n         *\n         * @param {Object} options Object containing options. Contextid is required.\n         * Each call to templates.render gets it's own instance of this class.\n         */\n        var Participants = function (options) {\n\n            this.courseId = options.courseid;\n            this.noteStateNames = options.noteStateNames;\n            this.stateHelpIcon = options.stateHelpIcon;\n\n            this.attachEventListeners();\n        };\n        // Class variables and functions.\n\n        /**\n         * @var {Modal} modal\n         * @private\n         */\n        Participants.prototype.modal = null;\n\n        /**\n         * @var {int} courseId\n         * @private\n         */\n        Participants.prototype.courseId = -1;\n\n        /**\n         * @var {Object} noteStateNames\n         * @private\n         */\n        Participants.prototype.noteStateNames = {};\n\n        /**\n         * @var {String} stateHelpIcon\n         * @private\n         */\n        Participants.prototype.stateHelpIcon = \"\";\n\n        /**\n         * Private method\n         *\n         * @method attachEventListeners\n         * @private\n         */\n        Participants.prototype.attachEventListeners = function () {\n\n            $(SELECTORS.SENDMESSAGESBUTTON).on('click', function (e) {\n                e.preventDefault();\n                $('#participantsform #checkboxes').html('');\n                // Find selected.\n                var selected = [];\n                $('input[name=\\\"attemptid[]\\\"]:checked').each(function () {\n                    selected.push($(this).data('userid'));\n                });\n                if (selected.length == 0) {\n                    return;\n                }\n\n                Participants.prototype.showSendMessage(selected).fail(Notification.exception);\n            });\n        };\n\n        /**\n         * Show the send message popup.\n         *\n         * @method showSendMessage\n         * @private\n         * @param {int[]} users\n         * @return {Promise}\n         */\n        Participants.prototype.showSendMessage = function (users) {\n\n            if (users.length == 0) {\n                // Nothing to do.\n                return $.Deferred().resolve().promise();\n            }\n            var titlePromise = null;\n            if (users.length == 1) {\n                titlePromise = Str.get_string('sendbulkmessagesingle', 'core_message');\n            } else {\n                titlePromise = Str.get_string('sendbulkmessage', 'core_message', users.length);\n            }\n\n            return $.when(\n                ModalFactory.create({\n                    type: ModalFactory.types.SAVE_CANCEL,\n                    body: Templates.render('core_user/send_bulk_message', {})\n                }),\n                titlePromise\n            ).then(function (modal, title) {\n                // Keep a reference to the modal.\n                this.modal = modal;\n\n                this.modal.setTitle(title);\n                this.modal.setSaveButtonText(title);\n\n                // We want to focus on the action select when the dialog is closed.\n                this.modal.getRoot().on(ModalEvents.hidden, function () {\n                    $(SELECTORS.BULKACTIONSELECT).focus();\n                    this.modal.getRoot().remove();\n                }.bind(this));\n\n                this.modal.getRoot().on(ModalEvents.save, this.submitSendMessage.bind(this, users));\n\n                this.modal.show();\n\n                return this.modal;\n            }.bind(this));\n        };\n\n        /**\n         * Send a message to these users.\n         *\n         * @method submitSendMessage\n         * @private\n         * @param {int[]} users\n         * @param {Event} e Form submission event.\n         * @return {Promise}\n         */\n        Participants.prototype.submitSendMessage = function (users) {\n\n            var messageText = this.modal.getRoot().find('form textarea').val();\n\n            var messages = [],\n                i = 0;\n\n            for (i = 0; i < users.length; i++) {\n                messages.push({ touserid: users[i], text: messageText });\n            }\n\n            return Ajax.call([{\n                methodname: 'core_message_send_instant_messages',\n                args: { messages: messages }\n            }])[0].then(function (messageIds) {\n                if (messageIds.length == 1) {\n                    return Str.get_string('sendbulkmessagesentsingle', 'core_message');\n                } else {\n                    return Str.get_string('sendbulkmessagesent', 'core_message', messageIds.length);\n                }\n            }).then(function (msg) {\n                Notification.addNotification({\n                    message: msg,\n                    type: \"success\"\n                });\n                return true;\n            }).catch(Notification.exception);\n        };\n\n        return /** @alias module:core_user/participants */ {\n\n            'load': function (courseid) {\n                // return new Participants(options);\n                Ajax.call([\n                    {\n                        methodname: \"quiz_teacheroverview_get_init_params\",\n                        args: {\n                            'courseid': courseid,\n                        },\n                        done: params => {\n    \n                            var params = JSON.parse(params.params);\n\n                            options = params;\n    \n                            this.init(options);\n                        },\n                        fail: {}\n                    }\n                ]);\n            },\n\n            /**\n             * Initialise the unified user filter.\n             *\n             * @method init\n             * @param {Object} options - List of options.\n             * @return {Participants}\n             */\n            'init': function (options) {\n                return new Participants(options);\n            }\n        };\n    });\n"],"file":"participants.min.js"}